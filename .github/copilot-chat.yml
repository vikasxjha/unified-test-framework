name: ü§ñ Copilot Chat Validation & Guardrails

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  copilot-chat-validation:
    name: Copilot Chat Validation
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # Validate Copilot Control Files
      # --------------------------------------------------
      - name: Validate Copilot Instruction Files
        run: |
          echo "üîç Validating Copilot governance files..."
          test -f copilot-instructions.md || (echo "‚ùå copilot-instructions.md missing" && exit 1)
          test -f COPILOT_PROMPTS.md || (echo "‚ùå COPILOT_PROMPTS.md missing" && exit 1)
          echo "‚úÖ Copilot governance files present"

      # --------------------------------------------------
      # Static Guardrail Checks
      # --------------------------------------------------
      - name: Scan for Forbidden Patterns
        run: |
          echo "üîç Scanning codebase for forbidden patterns..."

          if grep -R "Thread.sleep" -n src; then
            echo "‚ùå Thread.sleep detected"
            exit 1
          fi

          if grep -R "MobileBy" -n src; then
            echo "‚ùå MobileBy detected ‚Äì use AppiumBy"
            exit 1
          fi

          if grep -R "TODO" -n src; then
            echo "‚ùå TODO comments detected"
            exit 1
          fi

          if grep -R "FIXME" -n src; then
            echo "‚ùå FIXME comments detected"
            exit 1
          fi

          echo "‚úÖ No forbidden patterns detected"

      # --------------------------------------------------
      # Validate Architecture Boundaries (Basic)
      # --------------------------------------------------
      - name: Validate Architecture Boundaries
        run: |
          echo "üîç Validating architecture boundaries..."

          if grep -R "assertThat" src/main/java/com/company/qa/unified/pages; then
            echo "‚ùå Assertions detected inside Page Objects"
            exit 1
          fi

          if grep -R "RestAssured" src/test/java/com/company/qa/unified/pages; then
            echo "‚ùå API logic detected inside Page Objects"
            exit 1
          fi

          echo "‚úÖ Architecture boundaries look clean"

      # --------------------------------------------------
      # Java Build Sanity Check
      # --------------------------------------------------
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Compile Project (Fail Fast)
        run: mvn -B -q clean compile

      # --------------------------------------------------
      # Smoke Confidence Check (API only)
      # --------------------------------------------------
      - name: Run Smoke Tests
        run: |
          mvn -B test \
            -Denv=qa \
            -Dplatform=api \
            -Dcucumber.filter.tags="@smoke"

      # --------------------------------------------------
      # PR Feedback
      # --------------------------------------------------
      - name: Comment on PR (Success)
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ **Copilot Chat Validation Passed**

  ‚Ä¢ Copilot governance files present
  ‚Ä¢ No forbidden patterns found
  ‚Ä¢ Architecture boundaries respected
  ‚Ä¢ Project compiles successfully
  ‚Ä¢ Smoke tests passed
  
  üöÄ Safe to continue review / merge.`
  })

- name: Comment on PR (Failure)
  if: failure() && github.event_name == 'pull_request'
  uses: actions/github-script@v7
  with:
    script: |
      github.rest.issues.createComment({
        issue_number: context.issue.number,
        owner: context.repo.owner,
        repo: context.repo.repo,
        body: `‚ùå **Copilot Chat Validation Failed**

  One or more guardrails were violated.

Please check:
  ‚Ä¢ Forbidden patterns (Thread.sleep, MobileBy, TODO)
  ‚Ä¢ Architecture rules (assertions in Page Objects)
  ‚Ä¢ Compilation or smoke test failures
  
  Fix issues before requesting re-review.`
  })
